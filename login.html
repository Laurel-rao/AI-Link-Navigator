<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - AI导航</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif';
        }
        #captcha-image-container {
            background-color: #4a5568; /* slate-600 */
            border-radius: 6px;
            display: inline-flex; /* To make it wrap content and align items */
            align-items: center; /* Vertically align items if needed */
            padding: 5px;
            border: 1px solid #718096; /* slate-500 */
            min-height: 50px; /* Ensure a minimum height for the CAPTCHA area */
        }
        #captcha-image {
            display: block; /* Remove extra space below image */
            max-height: 40px; /* Control image height */
        }
        #refresh-captcha-btn {
            margin-left: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #94a3b8; /* slate-400 */
        }
        #refresh-captcha-btn:hover {
            color: #60a5fa; /* blue-400 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex items-center justify-center text-white p-6">
    <div class="bg-slate-800/70 backdrop-blur-md p-8 md:p-10 rounded-2xl shadow-2xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-8">AI导航 - 系统登录</h1>
        <form id="login-form">
            <div class="mb-6">
                <label for="username" class="block text-sm font-medium text-slate-300 mb-2">账号</label>
                <input type="text" id="username" name="username" required
                       class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-150 ease-in-out"
                       placeholder="请输入账号">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-slate-300 mb-2">密码</label>
                <input type="password" id="password" name="password" required
                       class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-150 ease-in-out"
                       placeholder="请输入密码">
            </div>

            <div id="captcha-section" class="mb-6 hidden">
                <label for="captcha" class="block text-sm font-medium text-slate-300 mb-2">验证码</label>
                <div id="captcha-image-container" class="flex items-center mb-2">
                    <img id="captcha-image" src="" alt="验证码加载中..." title="验证码">
                    <button type="button" id="refresh-captcha-btn" title="刷新验证码">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <input type="text" id="captcha" name="captcha"
                       class="w-full bg-slate-700/50 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-150 ease-in-out"
                       placeholder="请输入上方验证码">
            </div>

            <button type="submit"
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-blue-500 transition duration-150 ease-in-out">
                登 录
            </button>
            <p id="error-message" class="text-red-400 text-sm mt-4 text-center"></p>
        </form>
    </div>

    <script>
        const captchaSection = document.getElementById('captcha-section');
        const captchaImage = document.getElementById('captcha-image');
        const captchaInput = document.getElementById('captcha');
        const refreshCaptchaBtn = document.getElementById('refresh-captcha-btn');

        function loadNewCaptcha() {
            // Add a timestamp to prevent browser caching of the image
            captchaImage.src = '/api/captcha-image?' + new Date().getTime();
            captchaInput.value = ''; // Clear previous input
            captchaSection.style.display = 'block';
            captchaInput.focus();
        }

        if (refreshCaptchaBtn) {
            refreshCaptchaBtn.addEventListener('click', loadNewCaptcha);
        }

        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessageElement = document.getElementById('error-message');
            errorMessageElement.textContent = '';

            const payload = { username, password };
            if (captchaSection.style.display !== 'none' && captchaSection.style.display !== '') {
                payload.captcha = captchaInput.value;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirect_url || '/';
                } else {
                    errorMessageElement.textContent = result.message || '登录失败，请重试。';
                    if (result.require_captcha) {
                        loadNewCaptcha(); // Load new image when captcha is required
                    } 
                }
            } catch (error) {
                console.error('Login error:', error);
                errorMessageElement.textContent = '发生网络错误，请稍后重试。';
            }
        });

        // Check if captcha might be required on initial load (e.g. after a redirect where session already indicates it)
        // This approach might be simpler if the backend sets `session['require_captcha']` and the page reloads.
        // For now, we primarily trigger captcha display based on the API response from a failed login attempt.
        // If you want captcha to appear immediately on page load if `require_captcha` is already in session,
        // you would need to pass that state from Flask to the template, or make an initial API call.
        // Example: if ({{ session_requires_captcha_on_load | tojson }}) { loadNewCaptcha(); }
    </script>
</body>
</html> 